name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚ã®ã¿å®Ÿè¡Œ
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³: PRä½œæˆè€…ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # ã‚³ãƒ¡ãƒ³ãƒˆã®ç·¨é›†ã®ãŸã‚ã«writeã«å¤‰æ›´
      issues: write # ã‚³ãƒ¡ãƒ³ãƒˆã®ç·¨é›†ã®ãŸã‚ã«writeã«å¤‰æ›´
      id-token: write

    steps:
      # éå»ã®Claudeãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æœ€å°åŒ–
      - name: Minimize past Claude comments
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            // ãƒ‡ãƒãƒƒã‚°: ã‚³ãƒ¡ãƒ³ãƒˆæƒ…å ±ã‚’å‡ºåŠ›
            console.log(`ã‚³ãƒ¡ãƒ³ãƒˆç·æ•°: ${comments.data.length}`);

            // Claudeã‚¢ãƒ—ãƒªã«ã‚ˆã‚‹éå»ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æœ€å°åŒ–
            let minimizedCount = 0;
            for (const comment of comments.data) {
              console.log(`ã‚³ãƒ¡ãƒ³ãƒˆä½œè€…: ${comment.user.login}, ã‚¢ãƒ—ãƒª: ${comment.performed_via_github_app?.slug || 'ãªã—'}`);
              
              // Claudeã‚¢ãƒ—ãƒªã«ã‚ˆã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¯¾è±¡ã«ã™ã‚‹ï¼ˆã‚¢ãƒ—ãƒªåã§åˆ¤å®šï¼‰
              if (comment.performed_via_github_app && 
                  comment.performed_via_github_app.slug && 
                  comment.performed_via_github_app.slug.includes('claude') &&
                  !comment.body.includes('<details>')) {
                
                console.log(`æœ€å°åŒ–å¯¾è±¡: ã‚³ãƒ¡ãƒ³ãƒˆID ${comment.id}`);
                
                // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’<details>ã‚¿ã‚°ã§å›²ã‚€
                const minimizedBody = `<details>\n<summary>ğŸ¤– éå»ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ - ${new Date(comment.created_at).toLocaleString('ja-JP')}</summary>\n\n${comment.body}\n</details>`;
                
                try {
                  await github.rest.issues.updateComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: comment.id,
                    body: minimizedBody
                  });
                  minimizedCount++;
                } catch (error) {
                  console.error(`ã‚³ãƒ¡ãƒ³ãƒˆ ${comment.id} ã®æ›´æ–°ã«å¤±æ•—:`, error.message);
                }
              }
            }

            console.log(`${minimizedCount}ä»¶ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æœ€å°åŒ–ã—ã¾ã—ãŸ`);

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # PRå…¨ä½“ã®å·®åˆ†ã‚’å–å¾—ã™ã‚‹ãŸã‚

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: Claude Sonnet 4ã€Claude Opus 4ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã™ï¼‰
          # model: "claude-opus-4-20250514"

          # è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ç›´æ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ@claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã¯ä¸è¦ï¼‰
          direct_prompt: |
            ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ†æã—ã¦ã€ä»¥ä¸‹ã®2ã¤ã®ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

            ## ã‚¿ã‚¹ã‚¯1: PRèª¬æ˜ã®ç”Ÿæˆ
            æœ€åˆã«ã€PRã®å·®åˆ†ã‚’åˆ†æã—ã¦èª¬æ˜ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ï¼š

            <!-- PR_DESCRIPTION_START -->
            ## ğŸ“‹ å¤‰æ›´å†…å®¹ã®æ¦‚è¦

            ### ğŸ¯ ã“ã®PRã®ç›®çš„
            ï¼ˆPRã®ç›®çš„ã‚’ç°¡æ½”ã«è¨˜è¼‰ï¼‰

            ### âœ¨ ä¸»ãªå¤‰æ›´ç‚¹
            - å¤‰æ›´ç‚¹1
            - å¤‰æ›´ç‚¹2
            - ...

            ### ğŸ”§ æŠ€è¡“çš„ãªè©³ç´°
            ï¼ˆå®Ÿè£…ã®è©³ç´°ã€ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®èª¬æ˜ãªã©ï¼‰

            ### ğŸ“Š ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£/ãƒ•ãƒ­ãƒ¼å›³ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
            ```mermaid
            graph TD
                A[é–‹å§‹] --> B[å‡¦ç†]
                B --> C[çµ‚äº†]
            ```

            ### ğŸ“ ãã®ä»–ã®æ³¨æ„äº‹é …
            ï¼ˆç ´å£Šçš„å¤‰æ›´ã€ç§»è¡Œæ‰‹é †ãªã©ã€ã‚ã‚Œã°è¨˜è¼‰ï¼‰
            <!-- PR_DESCRIPTION_END -->

            ## ã‚¿ã‚¹ã‚¯2: ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
            æ¬¡ã«ã€ä»¥ä¸‹ã®è¦³ç‚¹ã§ã‚³ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼š
            - ã‚³ãƒ¼ãƒ‰ã®å“è³ªã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
            - æ½œåœ¨çš„ãªãƒã‚°ã‚„å•é¡Œ
            - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®è€ƒæ…®äº‹é …
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®æ‡¸å¿µäº‹é …
            - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

            ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã¯å¿…ãšä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§å‡ºåŠ›ï¼š

            <details>
            <summary>ğŸ¤– Claude Code Review</summary>

            ### ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

            [ã“ã“ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã‚’è¨˜è¼‰]

            ---
            <sub>ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚</sub>
            </details>

          # ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
          # direct_prompt: |
          #   ä»¥ä¸‹ã®è¦³ç‚¹ã§PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼š
          #   - TypeScriptãƒ•ã‚¡ã‚¤ãƒ«: å‹å®‰å…¨æ€§ã¨é©åˆ‡ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®ä½¿ç”¨
          #   - APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€å…¥åŠ›æ¤œè¨¼ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          #   - Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
          #   - ãƒ†ã‚¹ãƒˆ: ã‚«ãƒãƒ¬ãƒƒã‚¸ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã€ãƒ†ã‚¹ãƒˆã®å“è³ª

          # ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ä½œæˆè€…ã«ã‚ˆã£ã¦ç•°ãªã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          # direct_prompt: |
          #   ${{ github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR' &&
          #   'ã‚ˆã†ã“ãï¼åˆã‚ã¦ã®ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ¼ã‹ã‚‰ã®PRã§ã™ã€‚åŠ±ã¾ã—ã®è¨€è‘‰ã¨å…±ã«ã€ææ¡ˆã«ã¤ã„ã¦è©³ã—ã„èª¬æ˜ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚' ||
          #   'ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«ç„¦ç‚¹ã‚’å½“ã¦ãŸè©³ç´°ãªã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚' }}

          # ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ãƒ†ã‚¹ãƒˆã‚„ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ç‰¹å®šã®ãƒ„ãƒ¼ãƒ«ã‚’è¿½åŠ 
          # allowed_tools: "Bash(npm run test),Bash(npm run lint),Bash(npm run typecheck)"

          # ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ç‰¹å®šã®æ¡ä»¶ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—
          # if: |
          #   !contains(github.event.pull_request.title, '[skip-review]') &&
          #   !contains(github.event.pull_request.title, '[WIP]')
